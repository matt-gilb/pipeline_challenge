services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.2.14
    command:
      - redpanda
      - start
      - --mode=dev-container
      - --smp=1
      - --memory=1G
      - --kafka-addr INTERNAL://0.0.0.0:29092
      - --advertise-kafka-addr INTERNAL://redpanda:29092
      - --pandaproxy-addr=PLAINTEXT://0.0.0.0:28082
      - --advertise-pandaproxy-addr=PLAINTEXT://redpanda:28082
    ports:
      - '29092:29092'
    healthcheck:
      test: ['CMD-SHELL', 'rpk cluster health']
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redpanda:/var/lib/redpanda/data

  clickhouse:
    image: clickhouse/clickhouse-server:25.3
    ports:
      - '8123:8123'
      - '9000:9000'
    volumes:
      - ./infra/clickhouse-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8123/ping']
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.14
    ports:
      - '7700:7700'
    volumes:
      - meili_data:/meili_data
    environment:
      - MEILI_MASTER_KEY=pipeline_secure_master_key_2024
      - MEILI_NO_ANALYTICS=true
      - MEILI_LOG_LEVEL=ERROR
      - MEILI_ENV=development
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          '-H',
          'Authorization: Bearer pipeline_secure_master_key_2024',
          'http://127.0.0.1:7700/health',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  event-generator:
    build:
      context: .
      dockerfile: ./apps/event-generator/Dockerfile
    environment:
      - KAFKA_BROKERS=redpanda:29092
    depends_on:
      redpanda:
        condition: service_healthy

  stream-worker:
    build:
      context: .
      dockerfile: ./apps/stream-worker/Dockerfile
    environment:
      - KAFKA_BROKERS=redpanda:29092
      - CLICKHOUSE_HOST=clickhouse
      - MEILISEARCH_HOST=meilisearch
      - MEILISEARCH_KEY=pipeline_secure_master_key_2024
    depends_on:
      redpanda:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      meilisearch:
        condition: service_healthy

  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
    ports:
      - '3000:3000'
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - MEILISEARCH_HOST=meilisearch
      - MEILISEARCH_KEY=pipeline_secure_master_key_2024
    depends_on:
      clickhouse:
        condition: service_healthy
      meilisearch:
        condition: service_healthy

  grafana:
    image: grafana/grafana:11.6.3
    ports:
      - '3001:3000'
    volumes:
      - ./infra/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./infra/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafana_data:/var/lib/grafana
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    depends_on:
      - clickhouse

volumes:
  clickhouse_data:
    driver: local
  meili_data:
    driver: local
  grafana_data:
    driver: local
  redpanda:
    driver: local
